name: CI/CD for Booklist Manager
 
on:

  push:

    branches:

      - main

      - master

  pull_request:

    branches:

      - main

      - master
 
jobs:

  build-and-test:

    runs-on: ubuntu-latest
 
    steps:

      - name: Checkout code

        uses: actions/checkout@v3
 
      - name: Set up Node.js

        uses: actions/setup-node@v3

        with:

          node-version: '18'
 
      - name: Install dependencies

        run: npm install
 
      - name: Run tests

        run: npm test
 
      - name: Upload coverage report

        uses: actions/upload-artifact@v2

        with:

          name: coverage-report

          path: coverage/
 
  deploy:

    needs: build-and-test

    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/main'
 
    steps:

      - name: Deploy to EC2 via SSH

        uses: appleboy/ssh-action@v1.0.0

        with:

          host: ${{ secrets.EC2_HOST }}

          username: ec2-user

          key: ${{ secrets.EC2_KEY }}

          script: |

            cd booklist-manager

            git pull origin main

            npm install

            pm2 restart all || pm2 start server.js --name booklist-api

 
